@ifndef@ INCPATH
INCPATH=../
@endif@

CFLAGS=
CC=gcc
LEX=flex

@sinclude@ @includel@$(INCPATH)defaults.mk@includel@
@sinclude@ @includel@$(INCPATH)settings.mk@includel@

@ifeq@${HOOKS_NEW}@ifeqsep@1@ifeqend@
HOOK_ENGINE=old
@else@
HOOK_ENGINE=new
@endif@

# if USE_VALGRIND == 1
@ifeq@${USE_VALGRIND}@ifeqsep@1@ifeqend@
  CFLAGS+=-DUSE_VALGRIND
  SSTRING_ENGINE=valgrind

  # if SSTRING_NEW == 1
  @ifeq@${SSTRING_NEW}@ifeqsep@1@ifeqend@
    IMPOSSIBLE="USE_VALGRIND and SSTRING_NEW"
  @endif@

  # if SSTRING_MMAP == 1
  @ifeq@${SSTRING_MMAP}@ifeqsep@1@ifeqend@
    IMPOSSIBLE="USE_VALGRIND and SSTRING_MMAP"
  @endif@
@else@

  # if SSTRING_NEW == 1
  @ifeq@${SSTRING_NEW}@ifeqsep@1@ifeqend@
    SSTRING_ENGINE=new
  @else@
    SSTRING_ENGINE=old

    # if SSTRING_MMAP == 1
    @ifeq@${SSTRING_MMAP}@ifeqsep@1@ifeqend@
      IMPOSSIBLE="SSTRING_MMAP without SSTRING_NEW"
    @endif@
  @endif@
@endif@

@ifeq@${SSTRING_NEW}@ifeqsep@1@ifeqend@
HOOK_ENGINE=old
@else@
HOOK_ENGINE=new
@endif@

@ifdef@ IMPOSSIBLE
@error@ impossible combination of settings: ${IMPOSSIBLE}@errorend@
@endif@

@ifndef@ BUILDID
BUILDID @shell@ (hg id || echo "unknown") | sed -e "s/+ /-/;s/ /-/" @shellend@
@endif@

.SUFFIXES: .so .y .l

.o.so:
	@-ldline-@ $(LDFLAGS)

.y.c:	;

.l.c:	;

.PHONY: checksettings default

default: checksettings all

checksettings:
	@test -f .settings.mk || cp settings.mk .settings.mk
	@diff .settings.mk settings.mk >/dev/null || $(MAKE) -e FORCECHECK=1 realchecksettings

realchecksettings:

@ifdef@ FORCECHECK
@error@ you must run make clean if you change settings.mk@errorend@
@endif@

CFLAGS+=-Wall -g -finline-functions -funroll-loops -std=c99 -I./ -DBUILDID=$(BUILDID)
CFLAGS+=-fPIC -export-dynamic
