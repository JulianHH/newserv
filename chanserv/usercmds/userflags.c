/* Automatically generated by refactor.pl.
 *
 *
 * CMDNAME: userflags
 * CMDLEVEL: QCMD_AUTHED
 * CMDARGS: 2
 * CMDDESC: Shows or changes user flags.
 * CMDFUNC: csu_douserflags
 * CMDPROTO: int csu_douserflags(void *source, int cargc, char **cargv);
 */

#include "../chanserv.h"
#include "../../lib/irc_string.h"
#include <stdio.h>
#include <string.h>

int csu_douserflags(void *source, int cargc, char **cargv) {
  nick *sender=source;
  reguser *rup=getreguserfromnick(sender), *target;
  int arg=0;
  flag_t flagmask, changemask, oldflags;
  char flagbuf[30];

  if (!rup)
    return CMD_ERROR;
  
  if (cargc<1) {
    chanservstdmessage(sender, QM_NOTENOUGHPARAMS, "userflags");
    return CMD_ERROR;
  }

  if (*cargv[0]!='+' && *cargv[0]!='-') {
    arg++;
    /* If the first char isn't a "change" character, it must specify a target */

    if (!(target=findreguser(sender,cargv[0])))
      return CMD_ERROR;

    if (target!=rup && !cs_privcheck(QPRIV_VIEWUSERFLAGS, sender)) {
      chanservstdmessage(sender, QM_NOACCESS, "userflags");
      return CMD_ERROR;
    }
  } else {
    target=rup;
  }
    
  if (cargc>arg) {
    /* OK, now we have a changestring.. */
    if (target!=rup && !cs_privcheck(QPRIV_CHANGEUSERFLAGS, sender)) {
      chanservstdmessage(sender, QM_NOACCESS, "userflags");
      return CMD_ERROR;
    }

    strcpy(flagbuf,printflags(target->flags, ruflags));
    oldflags=target->flags;

    changemask=QUFLAG_NOTICE | QUFLAG_INFO;

    if (target==rup) {
      /* If you're changing yourself, you can give up the "status" flags and add/remove notice */
      changemask|=(target->flags & (QUFLAG_OPER | QUFLAG_DEV | QUFLAG_PROTECT | QUFLAG_HELPER | QUFLAG_ADMIN));
    }

    /* Warning, policy ahead */

    if (UHasOperPriv(rup))
      changemask |= QUFLAG_GLINE | QUFLAG_DELAYEDGLINE | QUFLAG_RESTRICTED | QUFLAG_PROTECT;

    if (UHasAdminPriv(rup))
      changemask |= (QUFLAG_OPER | QUFLAG_HELPER);
    
    if (UIsDev(rup))
      changemask=QUFLAG_ALL;
    
    setflags(&target->flags, changemask, cargv[arg], ruflags, REJECT_NONE);
    
    /* More policy */
    if (!UHasHelperPriv(target)) {
      target->flags &= ~QUFLAG_PROTECT;
    }

    cs_log(sender,"USERFLAGS #%s %s (%s -> %s)",target->username,cargv[arg],flagbuf,printflags(target->flags, ruflags));

    /* only warn about interesting changes */
    if((target->flags ^ oldflags) & ~(QUFLAG_NOTICE | QUFLAG_INFO))
      chanservwallmessage("%s (%s) just used USERFLAGS on %s %s (%s -> %s)",sender->nick,rup->username,target->username,cargv[arg],flagbuf,printflags(target->flags,ruflags));

    csdb_updateuser(target);
    chanservstdmessage(sender, QM_DONE);
  }

  if (cs_privcheck(QPRIV_VIEWUSERFLAGS, sender))
    flagmask=QUFLAG_ALL;
  else
    flagmask=QUFLAG_INFO | QUFLAG_NOTICE | QUFLAG_OPER | QUFLAG_HELPER | QUFLAG_DEV | QUFLAG_ADMIN;
  
  chanservstdmessage(sender, QM_CURUSERFLAGS, target->username, printflags(target->flags & flagmask, ruflags));

  return CMD_OK;
}
